<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ewe Care - Sheep Health Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        body {
            background-color: #f0f2f5;
            color: #333;
        }
        .header-section {
            background-color: #fff;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .main-container {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none;
        }
        .status-healthy {
            color: #28a745;
            font-weight: bold;
        }
        .status-sick {
            color: #dc3545;
            font-weight: bold;
        }
        .status-treatment {
            color: #ffc107;
            font-weight: bold;
        }
        .loading {
            font-style: italic;
            color: #6c757d;
        }
        .nav-link.active {
            font-weight: bold;
            color: #007bff !important;
        }
        .reminder-card {
            background: #fcf8e3;
            border-left: 5px solid #f0ad4e;
            margin-bottom: 1rem;
            padding: 1rem 1.5rem;
        }
        .reminder-title {
            font-weight: bold;
            color: #f0ad4e;
        }
        .reminder-list {
            margin-bottom: 0;
        }
        .reminder-due {
            color: #dc3545;
            font-weight: bold;
        }
        .reminder-soon {
            color: #ffc107;
            font-weight: bold;
        }
        .reminder-red {
            color: #dc3545;
            font-weight: bold;
        }
        .reminder-green {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <header class="header-section text-center">
        <h1 class="display-4 text-primary">üêè Ewe Care</h1>
        <p class="lead text-muted">A simple application to track the health of your flock.</p>
    </header>
    <!-- Auth Section -->
    <div id="authSection" class="container main-container">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email" required>
        <input type="password" id="loginPassword" class="form-control mb-2" placeholder="Password" required>
        <button type="submit" class="btn btn-primary">Login</button>
        <button type="button" class="btn btn-secondary" onclick="showRequestForm()">Request Registration</button>
      </form>
      <!-- Registration form hidden by default -->
      <form id="registerForm" style="display:none;">
        <input type="email" id="registerEmail" class="form-control mb-2" placeholder="Email" required>
        <input type="password" id="registerPassword" class="form-control mb-2" placeholder="Password" required>
        <button type="submit" class="btn btn-success">Register</button>
        <button type="button" class="btn btn-link" onclick="showLogin()">Back to Login</button>
      </form>
      <div id="authError" class="text-danger mt-2"></div>
    </div>
    <!-- Request Registration Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="requestForm">
          <div class="modal-header">
            <h5 class="modal-title" id="requestModalLabel">Request Registration</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="text" class="form-control mb-2" id="requestName" placeholder="Your Name" required>
            <input type="email" class="form-control mb-2" id="requestEmail" placeholder="Your Email" required>
            <textarea class="form-control mb-2" id="requestReason" placeholder="Why do you want to register?" rows="3" required></textarea>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Send Request</button>
          </div>
        </form>
      </div>
    </div>
    <!-- Main App (hidden by default, shown after login) -->
    <div class="container main-container" id="mainApp" style="display:none;">
        <div class="d-flex justify-content-end mb-2">
            <button id="signOutBtn" class="btn btn-outline-danger btn-sm">Sign Out</button>
        </div>
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" href="#" onclick="showSection('home')">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('records')">Records</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('analytics')">Analytics</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('settings')">Settings</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('reminders')">Reminders</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('saled')">Saled</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#" onclick="showSection('treatment')">Treatment</a>
            </li>
        </ul>

        <div id="homeSection">
            <h2 class="mb-4">Add New Health Record</h2>
            <form id="sheepHealthForm">
                <div class="mb-3">
                    <label for="sheepId" class="form-label">Sheep ID</label>
                    <input type="text" class="form-control" id="sheepId" required>
                </div>
                <div class="mb-3">
                    <label for="healthStatus" class="form-label">Health Status</label>
                    <select class="form-select" id="healthStatus" required>
                        <option value="Healthy">Healthy</option>
                        <option value="Sick">Sick</option>
                        <option value="Under Treatment">Under Treatment</option>
                        <option value="Recovering">Recovering</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="dateRecorded" class="form-label">Date Recorded</label>
                    <input type="date" class="form-control" id="dateRecorded" required>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="weight" class="form-label">Weight (kg)</label>
                        <input type="number" step="0.1" class="form-control" id="weight">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="temperature" class="form-label">Temperature (¬∞C)</label>
                        <input type="number" step="0.1" class="form-control" id="temperature">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="notes" class="form-label">Notes</label>
                    <textarea class="form-control" id="notes" rows="3"></textarea>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">Reset</button>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add Record</button>
                </div>
            </form>
        </div>

        <div id="recordsSection" class="hidden">
            <h2 class="mb-4">All Health Records</h2>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="input-group w-50">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" onkeyup="filterRecords()" placeholder="Search by Sheep ID...">
                </div>
                <button class="btn btn-outline-success" onclick="exportData()"><i class="fas fa-download"></i> Export CSV</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Sheep ID</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Weight</th>
                            <th>Temp</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sheepHealthTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="analyticsSection" class="hidden">
            <h2 class="mb-4">Analytics & Stats</h2>
            <div class="row text-center mb-4">
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-primary">Total Records</h5>
                        <h1 id="totalCount">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-success">Healthy</h5>
                        <h1 id="healthyCount">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-danger">Sick</h5>
                        <h1 id="sickCount">0</h1>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card p-3">
                        <h5 class="text-warning">Under Treatment</h5>
                        <h1 id="treatmentCount">0</h1>
                    </div>
                </div>
            </div>
            <h4>Recent Activity</h4>
            <div id="recentActivity" class="bg-light p-3 rounded"></div>
        </div>

        <div id="settingsSection" class="hidden">
            <h2 class="mb-4">Settings</h2>
            <div class="card p-4">
                <h4>Firebase Connection Status</h4>
                <p>Test the connection to your Firebase database.</p>
                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-secondary me-2" id="connectionStatus">Not Tested</span>
                    <button class="btn btn-sm btn-outline-info" onclick="testConnection()">Test Connection</button>
                </div>
                <p class="text-muted small">If the connection fails, check your Firebase config and security rules.</p>
            </div>
        </div>

        <!-- Reminders Management Section (unchanged) -->
        <div id="remindersSection" class="hidden">
            <h2 class="mb-4">Manage Reminders</h2>
            <form id="reminderForm" class="mb-4">
                <div class="row">
                    <div class="col-md-2 mb-2">
                        <input type="text" class="form-control" id="reminderSheepId" placeholder="Sheep ID" required>
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="date" class="form-control" id="reminderDeworm" required>
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="date" class="form-control" id="reminderWeekly" required>
                    </div>
                    <div class="col-md-2 mb-2">
                        <input type="date" class="form-control" id="reminderWeight" required>
                    </div>
                    <div class="col-md-2 mb-2">
                        <button type="submit" class="btn btn-success">Add Reminder</button>
                    </div>
                </div>
            </form>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Sheep ID</th>
                            <th>Deworm</th>
                            <th>Weekly</th>
                            <th>Weight</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="remindersTableBody"></tbody>
                </table>
            </div>
        </div>
        <div id="saledSection" class="hidden">
            <h2 class="mb-4">Saled Sheep Records</h2>
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-outline-success" onclick="exportSaledData()"><i class="fas fa-download"></i> Export CSV</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Sheep ID</th>
                            <th>Status</th>
                            <th>Date Sold</th>
                            <th>Price</th>
                            <th>Buyer</th>
                            <th>Notes</th>
                        </tr>
                    </thead>
                    <tbody id="sheepSaledTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Edit Modal (Bootstrap) -->
        <div class="modal fade" id="editSheepModal" tabindex="-1" aria-labelledby="editSheepModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <form class="modal-content" id="editSheepForm">
              <div class="modal-header">
                <h5 class="modal-title" id="editSheepModalLabel">Edit Sheep Health Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="editRecordId">
                <div class="mb-3">
                  <label for="editSheepId" class="form-label">Sheep ID</label>
                  <input type="text" class="form-control" id="editSheepId" required>
                </div>
                <div class="mb-3">
                  <label for="editHealthStatus" class="form-label">Health Status</label>
                  <select class="form-select" id="editHealthStatus" required>
                    <option value="Healthy">Healthy</option>
                    <option value="Sick">Sick</option>
                    <option value="Under Treatment">Under Treatment</option>
                    <option value="Recovering">Recovering</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="editDateRecorded" class="form-label">Date Recorded</label>
                  <input type="date" class="form-control" id="editDateRecorded" required>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="editWeight" class="form-label">Weight (kg)</label>
                    <input type="number" step="0.1" class="form-control" id="editWeight">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="editTemperature" class="form-label">Temperature (¬∞C)</label>
                    <input type="number" step="0.1" class="form-control" id="editTemperature">
                  </div>
                </div>
                <div class="mb-3">
                  <label for="editNotes" class="form-label">Notes</label>
                  <textarea class="form-control" id="editNotes" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Sale Modal -->
        <div class="modal fade" id="saleSheepModal" tabindex="-1" aria-labelledby="saleSheepModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <form class="modal-content" id="saleSheepForm">
              <div class="modal-header">
                <h5 class="modal-title" id="saleSheepModalLabel">Sale Sheep Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="saleRecordId">
                <div class="mb-3">
                  <label for="saleDate" class="form-label">Date of Sale</label>
                  <input type="date" class="form-control" id="saleDate" required>
                </div>
                <div class="mb-3">
                  <label for="salePrice" class="form-label">Sale Price</label>
                  <input type="number" step="0.01" class="form-control" id="salePrice" required>
                </div>
                <div class="mb-3">
                  <label for="saleBuyer" class="form-label">Buyer Name</label>
                  <input type="text" class="form-control" id="saleBuyer" required>
                </div>
                <div class="mb-3">
                  <label for="saleNotes" class="form-label">Sale Notes</label>
                  <textarea class="form-control" id="saleNotes" rows="3"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-success">Confirm Sale</button>
              </div>
            </form>
          </div>
        </div>
         <!-- Treatment Section -->
        <div id="treatmentSection" class="hidden">
            <h2 class="mb-4">Treatment & Symptoms Log</h2>
            <form id="addTreatmentMainForm" class="mb-3">
                <div class="row">
                    <div class="col-md-2 mb-1">
                        <input type="text" id="mainTreatmentSheepId" class="form-control" placeholder="Sheep ID" required>
                    </div>
                    <div class="col-md-2 mb-1">
                        <input type="text" id="mainTreatmentReferId" class="form-control" placeholder="Reference ID" required>
                    </div>
                    <div class="col-md-2 mb-1">
                        <input type="date" id="mainTreatmentDate" class="form-control" required>
                    </div>
                    <div class="col-md-3 mb-1">
                        <input type="text" id="mainTreatmentSymptoms" class="form-control" placeholder="Symptoms" required>
                    </div>
                    <div class="col-md-3 mb-1">
                        <input type="text" id="mainTreatmentTreatment" class="form-control" placeholder="Treatment" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-success btn-sm mt-2">Add Entry</button>
            </form>
            <div class="table-responsive">
                <table class="table table-hover table-striped">
                    <thead>
                        <tr>
                            <th>Sheep ID</th>
                            <th>Reference ID</th>
                            <th>Date</th>
                            <th>Symptoms</th>
                            <th>Treatment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="treatmentLogTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Edit Reminder Modal -->
        <div class="modal fade" id="editReminderModal" tabindex="-1" aria-labelledby="editReminderModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <form class="modal-content" id="editReminderForm">
              <div class="modal-header">
                <h5 class="modal-title" id="editReminderModalLabel">Edit Reminder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="editReminderId">
                <div class="mb-3">
                  <label for="editReminderSheepId" class="form-label">Sheep ID</label>
                  <input type="text" class="form-control" id="editReminderSheepId" disabled>
                </div>
                <div class="mb-3">
                  <label for="editReminderDeworm" class="form-label">Deworm Date</label>
                  <div class="input-group">
                    <input type="date" class="form-control" id="editReminderDeworm">
                    <button class="btn btn-outline-secondary" type="button" onclick="changeDewormDate(-1)">-1d</button>
                    <button class="btn btn-outline-secondary" type="button" onclick="changeDewormDate(1)">+1d</button>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="editReminderWeekly" class="form-label">Weekly Date</label>
                  <input type="date" class="form-control" id="editReminderWeekly">
                </div>
                <div class="mb-3">
                  <label for="editReminderWeight" class="form-label">Weight Date</label>
                  <input type="date" class="form-control" id="editReminderWeight">
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
    </div>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.3/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyBdiEUorFPkiZAya84Xzx17id82nB77Zg4",
        authDomain: "sheep-1b6a7.firebaseapp.com",
        databaseURL: "https://sheep-1b6a7-default-rtdb.firebaseio.com",
        projectId: "sheep-1b6a7",
        storageBucket: "sheep-1b6a7.firebasestorage.app",
        messagingSenderId: "243565434909",
        appId: "1:243565434909:web:25312f89033e3fd0d54ef4"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- AUTH LOGIC ---
    const authSection = document.getElementById('authSection');
    const mainApp = document.getElementById('mainApp');
    const signOutBtn = document.getElementById('signOutBtn');
    mainApp.style.display = 'none';
    authSection.style.display = '';
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            authSection.style.display = 'none';
            mainApp.style.display = '';
        } else {
            authSection.style.display = '';
            mainApp.style.display = 'none';
        }
    });
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      firebase.auth().signInWithEmailAndPassword(email, password)
        .catch(function(error) {
          document.getElementById('authError').textContent = error.message;
        });
    });
    // Registration form hidden by default.
    document.getElementById('registerForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      firebase.auth().createUserWithEmailAndPassword(email, password)
        .then(function() { showLogin(); })
        .catch(function(error) {
          document.getElementById('authError').textContent = error.message;
        });
    });
    function showRegister() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('registerForm').style.display = '';
      document.getElementById('authError').textContent = '';
    }
    function showLogin() {
      document.getElementById('loginForm').style.display = '';
      document.getElementById('registerForm').style.display = 'none';
      document.getElementById('authError').textContent = '';
    }
    signOutBtn.addEventListener('click', function() {
      firebase.auth().signOut();
    });

    // --- Registration Request Logic ---
    function showRequestForm() {
      new bootstrap.Modal(document.getElementById('requestModal')).show();
    }
    document.getElementById('requestForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const name = document.getElementById('requestName').value.trim();
      const email = document.getElementById('requestEmail').value.trim();
      const reason = document.getElementById('requestReason').value.trim();
      if (!name || !email || !reason) return;
      const requestData = {
        name, email, reason,
        timestamp: new Date().toISOString()
      };
      firebase.database().ref("registrationRequests").push(requestData).then(() => {
        alert("Your registration request has been sent!");
        document.getElementById('requestForm').reset();
        bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
      }).catch((error) => {
        alert("Error sending request: " + error.message);
      });
    });

    // --- MAIN APP LOGIC ---
    const sheepHealthForm = document.getElementById('sheepHealthForm');
    const sheepHealthTableBody = document.getElementById('sheepHealthTableBody');
    const sheepSaledTableBody = document.getElementById('sheepSaledTableBody');
    let allRecords = [];
    let allSaledRecords = [];
    let allReminders = [];

    document.getElementById('dateRecorded').valueAsDate = new Date();

    function showSection(sectionName) {
        const sections = ['homeSection', 'recordsSection', 'analyticsSection', 'settingsSection', 'remindersSection', 'saledSection'];
        sections.forEach(section => {
            document.getElementById(section).classList.add('hidden');
        });
        document.getElementById(sectionName + 'Section').classList.remove('hidden');
        if (sectionName === 'records') fetchHealthRecords();
        else if (sectionName === 'saled') fetchSaledRecords();
        else if (sectionName === 'analytics') updateAnalytics();
        else if (sectionName === 'settings') checkConnectionStatus();
        else if (sectionName === "reminders") fetchReminders();
    }

    function fetchHealthRecords() {
        sheepHealthTableBody.innerHTML = '<tr><td colspan="7" class="text-center loading">Loading records...</td></tr>';
        db.ref("sheepHealthRecords").orderByChild("dateRecorded").once("value", (snapshot) => {
            allRecords = [];
            if (!snapshot.exists()) {
                sheepHealthTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No sheep health records found. Add your first record!</td></tr>';
                return;
            }
            sheepHealthTableBody.innerHTML = '';
            snapshot.forEach(childSnapshot => {
                const record = { id: childSnapshot.key, ...childSnapshot.val() };
                allRecords.push(record);
            });
            allRecords.reverse();
            sheepHealthTableBody.innerHTML = '';
            allRecords.forEach(record => addRecordToTable(record));
            updateStats();
        }, (error) => {
            sheepHealthTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading records: ' + error.message + '</td></tr>';
            console.error(error);
        });
    }


    


    function fetchSaledRecords() {
        sheepSaledTableBody.innerHTML = '<tr><td colspan="6" class="text-center loading">Loading saled records...</td></tr>';
        db.ref("sheepSaledRecords").orderByChild("saleDate").once("value", (snapshot) => {
            allSaledRecords = [];
            if (!snapshot.exists()) {
                sheepSaledTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No saled sheep records found.</td></tr>';
                return;
            }
            sheepSaledTableBody.innerHTML = '';
            snapshot.forEach(childSnapshot => {
                const record = { id: childSnapshot.key, ...childSnapshot.val() };
                allSaledRecords.push(record);
            });
            allSaledRecords.reverse();
            sheepSaledTableBody.innerHTML = '';
            allSaledRecords.forEach(record => addSaledRecordToTable(record));
        }, (error) => {
            sheepSaledTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading saled records: ' + error.message + '</td></tr>';
            console.error(error);
        });
    }

    function addRecordToTable(record) {
        const statusClass = getStatusClass(record.healthStatus);
        const dateRecorded = record.dateRecorded || '';
        const row = `
            <tr>
                <td><strong>${record.sheepId}</strong></td>
                <td><span class="${statusClass}">${record.healthStatus}</span></td>
                <td>${dateRecorded || 'N/A'}</td>
                <td>${record.weight || 'N/A'}</td>
                <td>${record.temperature || 'N/A'}</td>
                <td>${record.notes || 'No notes'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editRecord('${record.id}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="saleRecord('${record.id}')">
                        <i class="fas fa-money-bill-wave"></i> Sale
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteRecord('${record.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        sheepHealthTableBody.innerHTML += row;
    }
    function addSaledRecordToTable(record) {
        const row = `
            <tr>
                <td><strong>${record.sheepId}</strong></td>
                <td>${record.healthStatus || 'N/A'}</td>
                <td>${record.saleDate || 'N/A'}</td>
                <td>${record.salePrice || 'N/A'}</td>
                <td>${record.saleBuyer || 'N/A'}</td>
                <td>${record.saleNotes || record.notes || ''}</td>
            </tr>
        `;
        sheepSaledTableBody.innerHTML += row;
    }
    function getStatusClass(status) {
        switch (status) {
            case 'Healthy': return 'status-healthy';
            case 'Sick': return 'status-sick';
            case 'Under Treatment': case 'Recovering': return 'status-treatment';
            default: return '';
        }
    }

    function updateStats() {
        const healthy = allRecords.filter(r => r.healthStatus === 'Healthy').length;
        const sick = allRecords.filter(r => r.healthStatus === 'Sick').length;
        const treatment = allRecords.filter(r => r.healthStatus === 'Under Treatment' || r.healthStatus === 'Recovering').length;
        document.getElementById('healthyCount').textContent = healthy;
        document.getElementById('sickCount').textContent = sick;
        document.getElementById('treatmentCount').textContent = treatment;
        document.getElementById('totalCount').textContent = allRecords.length;
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const sheepId = document.getElementById('sheepId').value.trim();
        const healthStatus = document.getElementById('healthStatus').value;
        const dateRecorded = document.getElementById('dateRecorded').value;
        const weight = document.getElementById('weight').value;
        const temperature = document.getElementById('temperature').value;
        const notes = document.getElementById('notes').value.trim();

        if (!sheepId || !healthStatus || !dateRecorded) {
            alert('Please fill out Sheep ID, Health Status, and Date.');
            return;
        }

        const record = {
            sheepId,
            healthStatus,
            dateRecorded,
            notes,
            timestamp: new Date().toISOString()
        };

        if (weight) record.weight = parseFloat(weight);
        if (temperature) record.temperature = parseFloat(temperature);

        db.ref("sheepHealthRecords").push(record)
            .then(() => {
                const submitBtn = document.querySelector('#sheepHealthForm button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Record Added!';
                submitBtn.classList.add('btn-success');
                submitBtn.classList.remove('btn-primary');

                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.add('btn-primary');
                    submitBtn.classList.remove('btn-success');
                }, 2000);

                sheepHealthForm.reset();
                document.getElementById('dateRecorded').valueAsDate = new Date();
                fetchHealthRecords();
            })
            .catch((error) => {
                alert('Error adding record: ' + error.message);
                console.error(error);
            });
    }

    function editRecord(recordId) {
        const record = allRecords.find(r => r.id === recordId);
        if (!record) return;

        document.getElementById('editRecordId').value = record.id;
        document.getElementById('editSheepId').value = record.sheepId;
        document.getElementById('editHealthStatus').value = record.healthStatus;
        document.getElementById('editDateRecorded').value = record.dateRecorded || '';
        document.getElementById('editWeight').value = record.weight || '';
        document.getElementById('editTemperature').value = record.temperature || '';
        document.getElementById('editNotes').value = record.notes || '';

        var editModal = new bootstrap.Modal(document.getElementById('editSheepModal'));
        editModal.show();
    }

    document.getElementById('editSheepForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('editRecordId').value;
        const sheepId = document.getElementById('editSheepId').value.trim();
        const healthStatus = document.getElementById('editHealthStatus').value;
        const dateRecorded = document.getElementById('editDateRecorded').value;
        const weight = document.getElementById('editWeight').value;
        const temperature = document.getElementById('editTemperature').value;
        const notes = document.getElementById('editNotes').value.trim();

        if (!sheepId || !healthStatus || !dateRecorded) {
            alert('Please fill out Sheep ID, Health Status, and Date.');
            return;
        }

        const updatedRecord = {
            sheepId,
            healthStatus,
            dateRecorded,
            notes,
            timestamp: new Date().toISOString()
        };
        if (weight) updatedRecord.weight = parseFloat(weight);
        if (temperature) updatedRecord.temperature = parseFloat(temperature);

        db.ref(`sheepHealthRecords/${id}`).update(updatedRecord)
            .then(() => {
                var editModal = bootstrap.Modal.getInstance(document.getElementById('editSheepModal'));
                editModal.hide();
                fetchHealthRecords();
            })
            .catch((error) => {
                alert('Error updating record: ' + error.message);
                console.error(error);
            });
    });

    function deleteRecord(recordId) {
        if (confirm('Are you sure you want to delete this record?')) {
            db.ref(`sheepHealthRecords/${recordId}`).remove()
                .then(() => {
                    fetchHealthRecords();
                })
                .catch((error) => {
                    alert('Error deleting record: ' + error.message);
                    console.error(error);
                });
        }
    }

    function saleRecord(recordId) {
        const record = allRecords.find(r => r.id === recordId);
        if (!record) return;
        document.getElementById('saleRecordId').value = record.id;
        document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('salePrice').value = '';
        document.getElementById('saleBuyer').value = '';
        document.getElementById('saleNotes').value = '';
        var saleModal = new bootstrap.Modal(document.getElementById('saleSheepModal'));
        saleModal.show();
    }
    document.getElementById('saleSheepForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const id = document.getElementById('saleRecordId').value;
        const saleDate = document.getElementById('saleDate').value;
        const salePrice = document.getElementById('salePrice').value;
        const saleBuyer = document.getElementById('saleBuyer').value.trim();
        const saleNotes = document.getElementById('saleNotes').value.trim();
        const record = allRecords.find(r => r.id === id);
        if (!record) return;
        const saledRecord = {
            ...record,
            saleDate,
            salePrice: salePrice ? parseFloat(salePrice) : '',
            saleBuyer,
            saleNotes,
            saledTimestamp: new Date().toISOString()
        };
        db.ref(`sheepSaledRecords`).push(saledRecord).then(() => {
            db.ref(`sheepHealthRecords/${id}`).remove().then(() => {
                var saleModal = bootstrap.Modal.getInstance(document.getElementById('saleSheepModal'));
                saleModal.hide();
                fetchHealthRecords();
            });
        }).catch((error) => {
            alert('Error moving to saled: ' + error.message);
            console.error(error);
        });
    });

    function filterRecords() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = sheepHealthTableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const sheepId = row.cells[0]?.textContent.toLowerCase() || '';
            if (sheepId.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    function resetForm() {
        sheepHealthForm.reset();
        document.getElementById('dateRecorded').valueAsDate = new Date();
    }

    function exportData() {
        if (allRecords.length === 0) {
            alert('No data to export');
            return;
        }
        const csv = convertToCSV(allRecords);
        downloadCSV(csv, 'sheep_health_records.csv');
    }

    function convertToCSV(data) {
        const header = 'Sheep ID,Health Status,Date Recorded,Weight,Temperature,Notes\n';
        const rows = data.map(record =>
            `${record.sheepId},${record.healthStatus},${record.dateRecorded || ''},${record.weight || ''},${record.temperature || ''},"${record.notes || ''}"`
        ).join('\n');
        return header + rows;
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    // Export CSV for Saled Sheep Records
    function exportSaledData() {
        if (allSaledRecords.length === 0) {
            alert('No data to export');
            return;
        }
        const csv = convertSaledToCSV(allSaledRecords);
        downloadCSV(csv, 'saled_sheep_records.csv');
    }

    function convertSaledToCSV(data) {
        const header = 'Sheep ID,Health Status,Date Sold,Sale Price,Buyer,Notes\n';
        const rows = data.map(record =>
            `${record.sheepId},${record.healthStatus || ''},${record.saleDate || ''},${record.salePrice || ''},${record.saleBuyer || ''},"${record.saleNotes || record.notes || ''}"`
        ).join('\n');
        return header + rows;
    }

    function updateAnalytics() {
        const statusCounts = {
            'Healthy': allRecords.filter(r => r.healthStatus === 'Healthy').length,
            'Sick': allRecords.filter(r => r.healthStatus === 'Sick').length,
            'Under Treatment': allRecords.filter(r => r.healthStatus === 'Under Treatment').length,
            'Recovering': allRecords.filter(r => r.healthStatus === 'Recovering').length
        };
        const recentRecords = allRecords.slice(0, 5);
        const activityHtml = recentRecords.map(record =>
            `<div class="border-bottom py-2">
                <strong>${record.sheepId}</strong> - ${record.healthStatus}
                <small class="text-muted d-block">${record.dateRecorded}</small>
            </div>`
        ).join('');
        document.getElementById('recentActivity').innerHTML = activityHtml || '<p class="text-muted">No recent activity</p>';
    }

    function checkConnectionStatus() {
        testConnection();
    }

    function testConnection() {
        const statusDiv = document.getElementById('connectionStatus');
        statusDiv.textContent = 'Testing...';
        statusDiv.className = 'badge bg-warning';
        db.ref("sheepHealthRecords").limitToFirst(1).once("value")
            .then(() => {
                statusDiv.textContent = 'Connected';
                statusDiv.className = 'badge bg-success';
            })
            .catch((error) => {
                statusDiv.textContent = 'Connection Failed';
                statusDiv.className = 'badge bg-danger';
                console.error('Connection test failed:', error);
            });
    }

    sheepHealthForm.addEventListener('submit', handleFormSubmit);

    ////////////// Reminders ///////////////////////////

     function fetchReminders() {
        const remindersTableBody = document.getElementById('remindersTableBody');
        remindersTableBody.innerHTML = '<tr><td colspan="5" class="text-center loading">Loading reminders...</td></tr>';
       db.ref("sheepReminders").orderByChild("saleDate").once("value", (snapshot) =>  {
            allReminders = [];
            remindersTableBody.innerHTML = '';
            snapshot.forEach(childSnapshot => {
                const reminder = { id: childSnapshot.key, ...childSnapshot.val() };
                allReminders.push(reminder);
            });
            allReminders.forEach(reminder => {
                remindersTableBody.innerHTML += renderReminderRow(reminder);
            });
        });
    }
    function renderReminderRow(rem) {
        return `<tr>
            <td>${rem.sheepId}</td>
            <td>
                <span class="${getReminderClass(rem.dewormDate)}">Deworm: ${rem.dewormDate}</span>
            </td>
            <td>
                <span>${rem.weeklyDate}</span>
            </td>
            <td>
                <span>${rem.weightDate}</span>
            </td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="editReminder('${rem.id}')"><i class="fas fa-edit"></i></button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteReminder('${rem.id}')"><i class="fas fa-trash"></i></button>
            </td>
        </tr>`;
    }
    function getReminderClass(date) {
        const today = new Date().toISOString().split('T')[0];
        if (!date) return "";
        if (today > date) return "reminder-red";
        const dateObj = new Date(date);
        const todayObj = new Date(today);
        const daysDiff = (dateObj - todayObj) / (1000*60*60*24);
        if (daysDiff <= 3 && daysDiff >= 0) return "reminder-soon";
        return "reminder-green";
    }
    document.getElementById('reminderForm').addEventListener('submit', function(e){
        e.preventDefault();
        const sheepId = document.getElementById('reminderSheepId').value.trim();
        const dewormDate = document.getElementById('reminderDeworm').value;
        const weeklyDate = document.getElementById('reminderWeekly').value;
        const weightDate = document.getElementById('reminderWeight').value;
        if (!sheepId || !dewormDate || !weeklyDate || !weightDate) return;
        const data = { sheepId, dewormDate, weeklyDate, weightDate };
        db.ref("sheepReminders").push(data).then(() => {
            this.reset();
            fetchReminders();
        });
    });
    function editReminder(id) {
        const rem = allReminders.find(r => r.id === id);
        if (!rem) return;
        document.getElementById('editReminderId').value = rem.id;
        document.getElementById('editReminderSheepId').value = rem.sheepId;
        document.getElementById('editReminderDeworm').value = rem.dewormDate;
        document.getElementById('editReminderWeekly').value = rem.weeklyDate;
        document.getElementById('editReminderWeight').value = rem.weightDate;
        new bootstrap.Modal(document.getElementById('editReminderModal')).show();
    }
    document.getElementById('editReminderForm').addEventListener('submit', function(e){
        e.preventDefault();
        const id = document.getElementById('editReminderId').value;
        const dewormDate = document.getElementById('editReminderDeworm').value;
        const weeklyDate = document.getElementById('editReminderWeekly').value;
        const weightDate = document.getElementById('editReminderWeight').value;
        db.ref("sheepReminders/" + id).update({ dewormDate, weeklyDate, weightDate }).then(() => {
            bootstrap.Modal.getInstance(document.getElementById('editReminderModal')).hide();
            fetchReminders();
        });
    });
    function deleteReminder(id) {
        if (confirm("Delete reminder?")) {
            db.ref("sheepReminders/" + id).remove().then(fetchReminders);
        }
    }
    function changeDewormDate(days) {
        const input = document.getElementById('editReminderDeworm');
        let date = new Date(input.value);
        if (isNaN(date)) return;
        date.setDate(date.getDate() + days);
        input.value = date.toISOString().split('T')[0];
    }


     let allTreatments = [];

    function showSection(sectionName) {
        const sections = [
            'homeSection', 'recordsSection', 'analyticsSection',
            'settingsSection', 'remindersSection', 'saledSection', 'treatmentSection'
        ];
        sections.forEach(section => {
            document.getElementById(section).classList.add('hidden');
        });
        document.getElementById(sectionName + 'Section').classList.remove('hidden');
        // Fetch records for sections as needed
        if (sectionName === 'records') fetchHealthRecords();
        else if (sectionName === 'saled') fetchSaledRecords();
        else if (sectionName === 'analytics') updateAnalytics();
        else if (sectionName === 'settings') checkConnectionStatus();
        else if (sectionName === "reminders") fetchReminders();
        else if (sectionName === "treatment") fetchTreatments();
    }

    // CRUD for Treatment Section
    function fetchTreatments() {
        const tableBody = document.getElementById('treatmentLogTableBody');
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center loading">Loading...</td></tr>';
        // Get all sheepHealthRecords, only those with treatments
        db.ref("sheepHealthRecords").once("value", (snapshot) => {
            allTreatments = [];
            tableBody.innerHTML = '';
            snapshot.forEach(childSnapshot => {
                const sheepId = childSnapshot.key;
                const record = childSnapshot.val();
                if (record.treatments) {
                    Object.entries(record.treatments).forEach(([treatmentId, treatment]) => {
                        allTreatments.push({
                            sheepId,
                            treatmentId,
                            ...treatment
                        });
                    });
                }
            });
            if (allTreatments.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No treatment log entries found.</td></tr>';
                return;
            }
            allTreatments.forEach(t => addTreatmentToTable(t));
        });
    }

    function addTreatmentToTable(treatment) {
        const row = `
            <tr>
                <td>${treatment.sheepId}</td>
                <td>${treatment.referId}</td>
                <td>${treatment.date}</td>
                <td>${treatment.symptoms}</td>
                <td>${treatment.treatment}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editTreatment('${treatment.sheepId}', '${treatment.treatmentId}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteTreatment('${treatment.sheepId}', '${treatment.treatmentId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        document.getElementById('treatmentLogTableBody').innerHTML += row;
    }

    document.getElementById('addTreatmentMainForm').addEventListener('submit', function(e){
        e.preventDefault();
        const sheepId = document.getElementById('mainTreatmentSheepId').value.trim();
        const referId = document.getElementById('mainTreatmentReferId').value.trim();
        const date = document.getElementById('mainTreatmentDate').value;
        const symptoms = document.getElementById('mainTreatmentSymptoms').value.trim();
        const treatment = document.getElementById('mainTreatmentTreatment').value.trim();
        if (!sheepId || !referId || !date || !symptoms || !treatment) return;
        const treatmentData = { referId, date, symptoms, treatment };
        db.ref(`sheepHealthRecords/${sheepId}/treatments`).push(treatmentData).then(() => {
            this.reset();
            fetchTreatments();
        });
    });

    // Edit treatment
    function editTreatment(sheepId, treatmentId) {
        db.ref(`sheepHealthRecords/${sheepId}/treatments/${treatmentId}`).once("value", snapshot => {
            if (!snapshot.exists()) return;
            const t = snapshot.val();
            document.getElementById('editTreatmentId').value = treatmentId;
            document.getElementById('editTreatmentSheepId').value = sheepId;
            document.getElementById('editTreatmentReferId').value = t.referId;
            document.getElementById('editTreatmentDate').value = t.date;
            document.getElementById('editTreatmentSymptoms').value = t.symptoms;
            document.getElementById('editTreatmentTreatment').value = t.treatment;
            new bootstrap.Modal(document.getElementById('editTreatmentModal')).show();
        });
    }

    document.getElementById('editTreatmentForm').addEventListener('submit', function(e){
        e.preventDefault();
        const sheepId = document.getElementById('editTreatmentSheepId').value;
        const treatmentId = document.getElementById('editTreatmentId').value;
        const referId = document.getElementById('editTreatmentReferId').value;
        const date = document.getElementById('editTreatmentDate').value;
        const symptoms = document.getElementById('editTreatmentSymptoms').value;
        const treatment = document.getElementById('editTreatmentTreatment').value;
        db.ref(`sheepHealthRecords/${sheepId}/treatments/${treatmentId}`).set({referId, date, symptoms, treatment}).then(()=>{
            bootstrap.Modal.getInstance(document.getElementById('editTreatmentModal')).hide();
            fetchTreatments();
        });
    });

    // Delete treatment
    function deleteTreatment(sheepId, treatmentId) {
        if (confirm("Delete treatment entry?")) {
            db.ref(`sheepHealthRecords/${sheepId}/treatments/${treatmentId}`).remove().then(()=>{
                fetchTreatments();
            });
        }
    }
    /////////////////

//     function fetchHealthRecords() {
//   db.ref("sheepHealthRecords").once("value", (snapshot) => {
//     const allRecords = [];
//     snapshot.forEach(childSnapshot => {
//       const record = { id: childSnapshot.key, ...childSnapshot.val() };
//       // Show only Healthy or Recovering
//       if (record.healthStatus === 'Healthy' || record.healthStatus === 'Recovering') {
//         allRecords.push(record);
//       }
//     });
//     // Render your table from allRecords
//   });
// }

// function fetchTreatmentRecords() {
//   db.ref("sheepHealthRecords").once("value", (snapshot) => {
//     const treatmentRecords = [];
//     snapshot.forEach(childSnapshot => {
//       const record = { id: childSnapshot.key, ...childSnapshot.val() };
//       // Show only Sick or Under Treatment
//       if (record.healthStatus === 'Sick' || record.healthStatus === 'Under Treatment') {
//         treatmentRecords.push(record);
//       }
//     });
//     // Render your table from treatmentRecords
//   });
// }

    </script>
</body>
</html>